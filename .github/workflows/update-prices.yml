name: Update Prices (Amazon)

on:
  schedule:
    # Hor√°rios UTC: 03h, 09h, 15h, 21h
    # Hor√°rios BRT: 00h, 06h, 12h, 18h
    # Scraping + Browser apenas √†s 09h UTC (06h BRT)
    - cron: "0 3,9,15,21 * * *"

  workflow_dispatch:
    inputs:
      force_scrape:
        description: "For√ßar Scraping + Browser?"
        type: boolean
        default: false

jobs:
  update-prices:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # CHECKOUT
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # NODE
      # =========================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # =========================
      # DEPEND√äNCIAS
      # =========================
      - name: Install dependencies
        run: npm ci

      # =========================
      # PRISMA
      # =========================
      - name: Generate Prisma Client
        run: npx prisma generate

      # =========================
      # PLAYWRIGHT (Chromium)
      # S√≥ instala quando necess√°rio
      # =========================
      - name: Install Playwright Chromium
        if: |
          github.event_name == 'workflow_dispatch' && inputs.force_scrape == true ||
          github.event_name == 'schedule'
        run: npx playwright install chromium

      # =========================
      # AMAZON UPDATE
      # =========================
      - name: Update Amazon prices
        run: |
          # Hora atual em UTC
          HOUR=$(date -u +%H)

          # Se for 09h UTC (06h BRT) ou se foi for√ßado manualmente
          if [ "$HOUR" = "09" ] || [ "${{ inputs.force_scrape }}" = "true" ]; then
            echo "üî• Executando COM Scraping + Playwright (Hor√°rio Principal)..."
            npx tsx scripts/updateAmazonPrices.ts --scrape --browser
          else
            echo "üõ°Ô∏è Executando SEM Scraping (Modo Seguro)..."
            npx tsx scripts/updateAmazonPrices.ts
          fi
        env:
          # Banco de Dados
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}

          # Amazon API
          AMAZON_ACCESS_KEY: ${{ secrets.AMAZON_ACCESS_KEY }}
          AMAZON_SECRET_KEY: ${{ secrets.AMAZON_SECRET_KEY }}
          AMAZON_PARTNER_TAG: ${{ secrets.AMAZON_PARTNER_TAG }}
          AMAZON_REGION: ${{ secrets.AMAZON_REGION }}
          AMAZON_HOST: ${{ secrets.AMAZON_HOST }}
